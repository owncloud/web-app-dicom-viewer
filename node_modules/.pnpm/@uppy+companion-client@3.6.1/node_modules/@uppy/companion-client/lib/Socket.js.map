{"version":3,"names":["ee","_queued","_classPrivateFieldLooseKey","_emitter","_isOpen","_socket","_handleMessage","_Symbol$for","Symbol","for","_Symbol$for2","UppySocket","constructor","opts","Object","defineProperty","writable","value","e","message","JSON","parse","data","emit","action","payload","err","console","log","autoOpen","open","isOpen","_classPrivateFieldLooseBase","WebSocket","target","onopen","length","first","shift","send","onclose","onmessage","close","_classPrivateFieldLoo","push","stringify","on","handler","once"],"sources":["Socket.js"],"sourcesContent":["import ee from 'namespace-emitter'\n\nexport default class UppySocket {\n  #queued = []\n\n  #emitter = ee()\n\n  #isOpen = false\n\n  #socket\n\n  constructor (opts) {\n    this.opts = opts\n\n    if (!opts || opts.autoOpen !== false) {\n      this.open()\n    }\n  }\n\n  get isOpen () { return this.#isOpen }\n\n  [Symbol.for('uppy test: getSocket')] () { return this.#socket }\n\n  [Symbol.for('uppy test: getQueued')] () { return this.#queued }\n\n  open () {\n    if (this.#socket != null) return\n\n    this.#socket = new WebSocket(this.opts.target)\n\n    this.#socket.onopen = () => {\n      this.#isOpen = true\n\n      while (this.#queued.length > 0 && this.#isOpen) {\n        const first = this.#queued.shift()\n        this.send(first.action, first.payload)\n      }\n    }\n\n    this.#socket.onclose = () => {\n      this.#isOpen = false\n      this.#socket = null\n    }\n\n    this.#socket.onmessage = this.#handleMessage\n  }\n\n  close () {\n    this.#socket?.close()\n  }\n\n  send (action, payload) {\n    // attach uuid\n\n    if (!this.#isOpen) {\n      this.#queued.push({ action, payload })\n      return\n    }\n\n    this.#socket.send(JSON.stringify({\n      action,\n      payload,\n    }))\n  }\n\n  on (action, handler) {\n    this.#emitter.on(action, handler)\n  }\n\n  emit (action, payload) {\n    this.#emitter.emit(action, payload)\n  }\n\n  once (action, handler) {\n    this.#emitter.once(action, handler)\n  }\n\n  #handleMessage = (e) => {\n    try {\n      const message = JSON.parse(e.data)\n      this.emit(message.action, message.payload)\n    } catch (err) {\n      // TODO: use a more robust error handler.\n      console.log(err) // eslint-disable-line no-console\n    }\n  }\n}\n"],"mappings":"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"}