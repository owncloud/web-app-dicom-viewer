{"version":3,"names":["_classPrivateFieldLooseBase","receiver","privateKey","Object","prototype","hasOwnProperty","call","TypeError","id","_classPrivateFieldLooseKey","name","RequestClient","tokenStorage","getName","split","map","s","charAt","toUpperCase","slice","join","getOrigin","location","origin","getRegex","value","RegExp","undefined","isOriginAllowed","allowedOrigin","patterns","Array","isArray","some","pattern","test","_refreshingTokenPromise","_getAuthToken","_removeAuthToken","Provider","constructor","uppy","opts","defineProperty","_removeAuthToken2","_getAuthToken2","writable","provider","pluginId","tokenKey","companionKeysParams","preAuthToken","headers","token","Promise","all","authHeaders","btoa","JSON","stringify","params","onReceiveResponse","response","plugin","getPlugin","oldAuthenticated","getPluginState","authenticated","status","setPluginState","setAuthToken","storage","setItem","ensurePreAuth","fetchPreAuthToken","Error","authUrl","queries","URLSearchParams","state","set","hostname","login","resolve","reject","link","authWindow","window","open","handleToken","e","source","jsonData","data","err","log","companionAllowedHosts","parse","error","message","i18n","info","close","removeEventListener","then","catch","addEventListener","refreshTokenUrl","fileUrl","request","arguments","authTokenAfter","isAuthError","path","method","uppyAuthToken","refreshTokenErr","res","post","list","directory","options","get","logout","initPlugin","defaultOpts","type","files","serverUrl","serverPattern","companionUrl","replace","URL","getItem","removeItem"],"sources":["Provider.js"],"sourcesContent":["'use strict'\n\nimport RequestClient from './RequestClient.js'\nimport * as tokenStorage from './tokenStorage.js'\n\nconst getName = (id) => {\n  return id.split('-').map((s) => s.charAt(0).toUpperCase() + s.slice(1)).join(' ')\n}\n\nfunction getOrigin () {\n  // eslint-disable-next-line no-restricted-globals\n  return location.origin\n}\n\nfunction getRegex (value) {\n  if (typeof value === 'string') {\n    return new RegExp(`^${value}$`)\n  } if (value instanceof RegExp) {\n    return value\n  }\n  return undefined\n}\n\nfunction isOriginAllowed (origin, allowedOrigin) {\n  const patterns = Array.isArray(allowedOrigin) ? allowedOrigin.map(getRegex) : [getRegex(allowedOrigin)]\n  return patterns\n    .some((pattern) => pattern?.test(origin) || pattern?.test(`${origin}/`)) // allowing for trailing '/'\n}\n\nexport default class Provider extends RequestClient {\n  #refreshingTokenPromise\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.provider = opts.provider\n    this.id = this.provider\n    this.name = this.opts.name || getName(this.id)\n    this.pluginId = this.opts.pluginId\n    this.tokenKey = `companion-${this.pluginId}-auth-token`\n    this.companionKeysParams = this.opts.companionKeysParams\n    this.preAuthToken = null\n  }\n\n  async headers () {\n    const [headers, token] = await Promise.all([super.headers(), this.#getAuthToken()])\n    const authHeaders = {}\n    if (token) {\n      authHeaders['uppy-auth-token'] = token\n    }\n\n    if (this.companionKeysParams) {\n      authHeaders['uppy-credentials-params'] = btoa(\n        JSON.stringify({ params: this.companionKeysParams }),\n      )\n    }\n    return { ...headers, ...authHeaders }\n  }\n\n  onReceiveResponse (response) {\n    super.onReceiveResponse(response)\n    const plugin = this.uppy.getPlugin(this.pluginId)\n    const oldAuthenticated = plugin.getPluginState().authenticated\n    const authenticated = oldAuthenticated ? response.status !== 401 : response.status < 400\n    plugin.setPluginState({ authenticated })\n    return response\n  }\n\n  async setAuthToken (token) {\n    return this.uppy.getPlugin(this.pluginId).storage.setItem(this.tokenKey, token)\n  }\n\n  async #getAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.getItem(this.tokenKey)\n  }\n\n  async #removeAuthToken () {\n    return this.uppy.getPlugin(this.pluginId).storage.removeItem(this.tokenKey)\n  }\n\n  /**\n   * Ensure we have a preauth token if necessary. Attempts to fetch one if we don't,\n   * or rejects if loading one fails.\n   */\n  async ensurePreAuth () {\n    if (this.companionKeysParams && !this.preAuthToken) {\n      await this.fetchPreAuthToken()\n\n      if (!this.preAuthToken) {\n        throw new Error('Could not load authentication data required for third-party login. Please try again later.')\n      }\n    }\n  }\n\n  authUrl (queries = {}) {\n    const params = new URLSearchParams({\n      state: btoa(JSON.stringify({ origin: getOrigin() })),\n      ...queries,\n    })\n    if (this.preAuthToken) {\n      params.set('uppyPreAuthToken', this.preAuthToken)\n    }\n\n    return `${this.hostname}/${this.id}/connect?${params}`\n  }\n\n  async login (queries) {\n    await this.ensurePreAuth()\n\n    return new Promise((resolve, reject) => {\n      const link = this.authUrl(queries)\n      const authWindow = window.open(link, '_blank')\n      const handleToken = (e) => {\n        if (e.source !== authWindow) {\n          let jsonData = ''\n          try {\n            // TODO improve our uppy logger so that it can take an arbitrary number of arguments,\n            // each either objects, errors or strings,\n            // then we donâ€™t have to manually do these things like json stringify when logging.\n            // the logger should never throw an error.\n            jsonData = JSON.stringify(e.data)\n          } catch (err) {\n            // in case JSON.stringify fails (ignored)\n          }\n          this.uppy.log(`ignoring event from unknown source ${jsonData}`, 'warning')\n          return\n        }\n\n        const { companionAllowedHosts } = this.uppy.getPlugin(this.pluginId).opts\n        if (!isOriginAllowed(e.origin, companionAllowedHosts)) {\n          reject(new Error(`rejecting event from ${e.origin} vs allowed pattern ${companionAllowedHosts}`))\n          return\n        }\n\n        // Check if it's a string before doing the JSON.parse to maintain support\n        // for older Companion versions that used object references\n        const data = typeof e.data === 'string' ? JSON.parse(e.data) : e.data\n\n        if (data.error) {\n          const { uppy } = this\n          const message = uppy.i18n('authAborted')\n          uppy.info({ message }, 'warning', 5000)\n          reject(new Error('auth aborted'))\n          return\n        }\n\n        if (!data.token) {\n          reject(new Error('did not receive token from auth window'))\n          return\n        }\n\n        authWindow.close()\n        window.removeEventListener('message', handleToken)\n        this.setAuthToken(data.token).then(() => resolve()).catch(reject)\n      }\n      window.addEventListener('message', handleToken)\n    })\n  }\n\n  refreshTokenUrl () {\n    return `${this.hostname}/${this.id}/refresh-token`\n  }\n\n  fileUrl (id) {\n    return `${this.hostname}/${this.id}/get/${id}`\n  }\n\n  /** @protected */\n  async request (...args) {\n    await this.#refreshingTokenPromise\n\n    try {\n      // to test simulate access token expired (leading to a token token refresh),\n      // see mockAccessTokenExpiredError in companion/drive.\n      // If you want to test refresh token *and* access token invalid, do this for example with Google Drive:\n      // While uploading, go to your google account settings,\n      // \"Third-party apps & services\", then click \"Companion\" and \"Remove access\".\n\n      return await super.request(...args)\n    } catch (err) {\n      // only handle auth errors (401 from provider), and only handle them if we have a (refresh) token\n      const authTokenAfter = await this.#getAuthToken()\n      if (!err.isAuthError || !authTokenAfter) throw err\n\n      if (this.#refreshingTokenPromise == null) {\n        // Many provider requests may be starting at once, however refresh token should only be called once.\n        // Once a refresh token operation has started, we need all other request to wait for this operation (atomically)\n        this.#refreshingTokenPromise = (async () => {\n          try {\n            this.uppy.log(`[CompanionClient] Refreshing expired auth token`, 'info')\n            const response = await super.request({ path: this.refreshTokenUrl(), method: 'POST' })\n            await this.setAuthToken(response.uppyAuthToken)\n          } catch (refreshTokenErr) {\n            if (refreshTokenErr.isAuthError) {\n              // if refresh-token has failed with auth error, delete token, so we don't keep trying to refresh in future\n              await this.#removeAuthToken()\n            }\n            throw err\n          } finally {\n            this.#refreshingTokenPromise = undefined\n          }\n        })()\n      }\n\n      await this.#refreshingTokenPromise\n\n      // now retry the request with our new refresh token\n      return super.request(...args)\n    }\n  }\n\n  async fetchPreAuthToken () {\n    if (!this.companionKeysParams) {\n      return\n    }\n\n    try {\n      const res = await this.post(`${this.id}/preauth/`, { params: this.companionKeysParams })\n      this.preAuthToken = res.token\n    } catch (err) {\n      this.uppy.log(`[CompanionClient] unable to fetch preAuthToken ${err}`, 'warning')\n    }\n  }\n\n  list (directory, options) {\n    return this.get(`${this.id}/list/${directory || ''}`, options)\n  }\n\n  async logout (options) {\n    const response = await this.get(`${this.id}/logout`, options)\n    await this.#removeAuthToken()\n    return response\n  }\n\n  static initPlugin (plugin, opts, defaultOpts) {\n    /* eslint-disable no-param-reassign */\n    plugin.type = 'acquirer'\n    plugin.files = []\n    if (defaultOpts) {\n      plugin.opts = { ...defaultOpts, ...opts }\n    }\n\n    if (opts.serverUrl || opts.serverPattern) {\n      throw new Error('`serverUrl` and `serverPattern` have been renamed to `companionUrl` and `companionAllowedHosts` respectively in the 0.30.5 release. Please consult the docs (for example, https://uppy.io/docs/instagram/ for the Instagram plugin) and use the updated options.`')\n    }\n\n    if (opts.companionAllowedHosts) {\n      const pattern = opts.companionAllowedHosts\n      // validate companionAllowedHosts param\n      if (typeof pattern !== 'string' && !Array.isArray(pattern) && !(pattern instanceof RegExp)) {\n        throw new TypeError(`${plugin.id}: the option \"companionAllowedHosts\" must be one of string, Array, RegExp`)\n      }\n      plugin.opts.companionAllowedHosts = pattern\n    } else if (/^(?!https?:\\/\\/).*$/i.test(opts.companionUrl)) {\n      // does not start with https://\n      plugin.opts.companionAllowedHosts = `https://${opts.companionUrl.replace(/^\\/\\//, '')}`\n    } else {\n      plugin.opts.companionAllowedHosts = new URL(opts.companionUrl).origin\n    }\n\n    plugin.storage = plugin.opts.storage || tokenStorage\n    /* eslint-enable no-param-reassign */\n  }\n}\n"],"mappings":"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"}